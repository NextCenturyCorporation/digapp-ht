<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/button-action/button-action.html">
<link rel="import" href="../../bower_components/date-picker-display/date-picker-display.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../behaviors.html">

<dom-module id="search-fields-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      .green[active],
      .green:hover {
        color: yellowgreen;
      }

      .search-labels {
        line-height: 25px;
        padding-top: 20px;
        text-align: end;
      }

      .instructions {
        padding-top: 0;
        padding-bottom: 30px;
      }

      .search-dialog paper-input {
        display: inline-block;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-input-color: var(--dark-primary-color);
        --paper-input-container-focus-color: var(--dark-primary-color);
        --paper-input-container: {
          padding: 0 10px 4px;
          width: 240px;
        }
        --paper-input-container-input: {
          font-weight: 500;
        }
      }

      .date-fields-title {
        padding-top: 30px;
      }

      .date-fields-container {
        padding: 20px 0 0;
      }

      .date-fields-container > date-picker-display {
        display: inline-block;
        margin: 0 10px;
        padding: 5px 0 9px;
        width: 240px;
        --date-select-bg-color: #ffffff;
        --date-select-text-color: #000000;
      }

      .search-dialog .search-buttons {
        padding-top: 20px;
      }

      styled-dialog ::content .inside.styled-dialog .styled-dialog-name {
        min-width: 100px;
      }

      @media all and (min-width: 500px) and (max-width: 650px) {
        .search-options-title {
          width: 100px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }

      @media all and (min-width: 0px) and (max-width: 500px) {
        .search-options-title {
          display: none;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }
    </style>

    <paper-button class="layout horizontal center bottom green" active="[[opened]]" on-tap="toggleSearchFieldsDialog" title="Click to Enter Search Terms">
      <iron-icon icon="search" class="bottom" style="margin-right: 5px;"></iron-icon>
      <span class="search-options-title">Click to Enter Search Terms</span>
    </paper-button>

    <styled-dialog
      class="search-dialog"
      modal
      opened="{{opened}}"
      on-opened-changed="toggleProcessRequest">

      <div class="layout vertical">
        <div class="layout horizontal">
          <div class="styled-dialog-name styled-dialog-right-space instructions">Instructions</div>
          <div class="styled-dialog-text">
            Enter words or phrases as <strong>search terms</strong> in one or more of the text fields below.
            Click the <strong>Search</strong> button or press the <strong>ENTER</strong> key when finished.
            Use <strong>commas</strong> to separate individual search terms.
            All punctuation <strong>except commas and periods</strong> will be removed.
            Example:  <strong>New York, Washington</strong>
          </div>
        </div>

        <template is="dom-repeat" items="[[_searchFields]]" as="dialogConfig">
          <div class="layout horizontal">
            <template is="dom-if" if="[[_equalsDate(dialogConfig.type)]]">
              <div class="styled-dialog-name styled-dialog-right-space search-labels date-fields-title">[[dialogConfig.name]]</div>
              <div class="layout horizontal date-fields-container">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <date-picker-display
                    facet-key="value"
                    facets="{{searchConfig}}"
                    key="[[searchConfig.key]]"
                    prefix-label="[[searchConfig.title]]"
                    date-identifier="[[searchConfig.dateId]]"
                    title="[[searchConfig.title]]">
                  </date-picker-display>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[!_equalsDate(dialogConfig.type)]]">
              <div class="styled-dialog-name styled-dialog-right-space search-labels">[[dialogConfig.name]]</div>
              <div class="layout horizontal wrap">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <paper-input
                    id$="input_[[searchConfig.key]]"
                    label="[[searchConfig.title]]"
                    value="{{searchConfig.value}}"
                    on-keydown="_checkSearchFieldInputKey">
                  </paper-input>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>

      <div class="horizontal layout center-justified search-buttons">
        <button-action class="styled-dialog-button" text="Search" on-tap="handleSearch"></button-action>
        <button-action class="styled-dialog-button" text="Reset" on-tap="resetAllSearchFields"></button-action>
        <button-action class="styled-dialog-button" text="Cancel" on-tap="cancelSearch"></button-action>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _, DigBehaviors */
    'use strict';

    Polymer({
      is: 'search-fields-dialog',
      behaviors: [DigBehaviors.FilterBehavior, DigBehaviors.PhoneBehavior],

      properties: {
        /**
         * The keys of dates in the searchFieldsConfig mapped to the keys of dates in the searchParameters.
         *
         * @type {Object}
         * @default {}
         */
        dateConfig: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * Whether the dialog is opened.
         *
         * @type {Boolean}
         * @default false
         */
        opened: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * Whether to let queries run.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },

        /**
         * Whether the user canceled the changes.
         *
         * @type {Boolean}
         * @default false
         */
        userCanceled: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * The data property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'data'
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * The date ID property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'dateIdentifier'
         */
        dataDateIdProperty: {
          type: String,
          value: 'dateIdentifier'
        },

        /**
         * The key property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'key'
         */
        dataKeyProperty: {
          type: String,
          value: 'key'
        },

        /**
         * The title property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'title'
         */
        dataTitleProperty: {
          type: String,
          value: 'title'
        },

        /**
         * The name property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'name'
         */
        nameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * The type property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'type'
         */
        typeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * A list of objects that correspond to groupings of search fields.
         *
         * @type {Array}
         */
        searchFieldsConfig: {
          type: Array
        },

        /**
         * A function that transforms search parameter data into a search parameter object.
         *
         * @type {Object}
         * @default function(category, enabled, key, text, date) { return { category: category, date: date, enabled: enabled, key: key, text: text }; }
         */
        searchParameterTransform: {
          type: Object,
          value: function() {
            return function(category, enabled, key, text, date) {
              return {
                category: category,
                date: date,
                enabled: enabled,
                key: key,
                text: text
              };
            };
          }
        },

        /**
         * The search parameters created from the terms entered into the dialog.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * The search fields shown in the dialog.
         *
         * @type {Array}
         * @private
         */
        _searchFields: {
          computed: '_createSearchFields(searchFieldsConfig, dataProperty, nameProperty, typeProperty, dataDateIdProperty, dataKeyProperty, dataTitleProperty)',
          type: Array
        }
      },

      observers: [
        'toggleProcessRequest(searchParameters.*)'
      ],

      /**
       * Toggles whether to let queries run whenever the search parameters change or the dialog is opened or closed.
       */
      toggleProcessRequest: function() {
        this.processRequest = !this.opened && !this.userCanceled;
        // reset user canceled variable
        this.userCanceled = false;
      },

      /**
       * Updates the search fields shown in the dialog from the search parameters if opening the dialog, then opens or closes the dialog.
       */
      toggleSearchFieldsDialog: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        // Set or clear the search fields whenever the dialog is opened.
        if(!this.opened) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self._updateDateFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex, 'value']);
                } else {
                  self._updateSearchFieldFromParameter(searchConfig);
                }
              });
            }
          });
        }

        this.opened = !this.opened;
      },

      /**
       * Creates and returns the search fields shown in the dialog.
       *
       * @param {Array} config
       * @param {String} dataProperty
       * @param {String} nameProperty
       * @param {String} typeProperty
       * @param {String} dataDateIdProperty
       * @param {String} dataKeyProperty
       * @param {String} dataTitleProperty
       * @return {Array}
       * @private
       */
      _createSearchFields: function(config, dataProperty, nameProperty, typeProperty, dataDateIdProperty, dataKeyProperty, dataTitleProperty) {
        var dateKeys = _.keys(this.dateConfig);
        return config.map(function(dialogConfig) {
          return {
            data: dialogConfig[dataProperty].map(function(searchConfig) {
              var isDate = (dateKeys.indexOf(searchConfig[dataKeyProperty]) >= 0);
              return {
                dateId: searchConfig[dataDateIdProperty],
                key: searchConfig[dataKeyProperty],
                title: searchConfig[dataTitleProperty],
                value: isDate ? {} : ''
              };
            }),
            name: dialogConfig[nameProperty],
            type: dialogConfig[typeProperty]
          };
        });
      },

      /**
       * Returns whether the given argument is 'date'.
       *
       * @param {String} string
       * @return {Boolean}
       * @private
       */
      _equalsDate: function(string) {
        return string === 'date';
      },

      /**
       * Updates the searchParameters with a new object and notifies observers.
       *
       * @param {String} type
       * @param {String} term
       * @param {String} title
       * @param {Boolean} enabled
       * @private
       */
      _updateSearchParameterAndNotify: function(type, term, title, enabled) {
        this.searchParameters[type][term] = this.searchParameterTransform(title, enabled, term, term);

        // TODO Do we really need to create a different object?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', type, '*'], this.searchParameterTransform(title, enabled, term, term));
      },

      /**
       * Updates the searchParameters from the given config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchParameterFromField: function(searchConfig) {
        var self = this;
        var terms = searchConfig.value.split(',').map(function(term) {
          // TODO Custom formatting.
          if(searchConfig.key === 'phone') {
            return DigBehaviors.PhoneBehavior.getUnformattedPhones(term);
          }
          // Replace reserved characters with spaces.
          return term.replace(/\+|\-|\=|\&|\||\>|<|\!|\(|\)|\{|\}|\[|\]|\^|\"|\~|\*|\?|\:|\\|\//g, ' ').trim();
        });

        // TODO Don't assume data structure.
        _.keys(self.searchParameters[searchConfig.key]).forEach(function(term) {
          // Disable deleted terms.
          if(self.searchParameters[searchConfig.key][term].enabled && terms.indexOf(term) < 0) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, false);
          }
        });

        terms.forEach(function(term) {
          // Add new terms.
          if(term) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, true);
          }
        });
      },

      /**
       * Updates the searchParameters with a new date object and notifies observers.
       *
       * @param {String} key
       * @param {Object} date
       * @param {String} text
       * @param {String} category
       * @param {Boolean} enabled
       * @private
       */
      _updateDateParameterAndNotify: function(key, date, text, category, enabled) {
        var parameterKey = this.dateConfig[key];

        this.searchParameters[parameterKey][key] = this.searchParameterTransform(category, enabled, key, text, date);

        // TODO Do we really need to create a different object?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', parameterKey, key], this.searchParameterTransform(category, enabled, key, text, date));
      },

      /**
       * Updates the searchParameters from the given date config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateDateParameterFromField: function(searchConfig) {
        var parameterKey = this.dateConfig[searchConfig.key];
        // TODO Don't assume data structure.
        if(!_.isEmpty(searchConfig.value[searchConfig.key])) {
          var dateObject = searchConfig.value[searchConfig.key];
          this._updateDateParameterAndNotify(dateObject.key, dateObject.date, dateObject.text, dateObject.category, dateObject.enabled);
        } else if(this.searchParameters[parameterKey][searchConfig.key]) {
          this.searchParameters[parameterKey][searchConfig.key] = {};
          this.notifyPath(['searchParameters', parameterKey, searchConfig.key], {});
        }
      },

      /**
       * Updates the searchParameters from the search fields in the dialog by adding or removing search terms.
       *
       * @private
       */
      _updateSearchParametersFromFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        this._searchFields.forEach(function(dialogConfig) {
          if(dialogConfig.data) {
            dialogConfig.data.forEach(function(searchConfig) {
              if(dateKeys.indexOf(searchConfig.key) >= 0) {
                self._updateDateParameterFromField(searchConfig);
              } else {
                self._updateSearchParameterFromField(searchConfig);
              }
            });
          }
        });
      },

      /**
       * Updates the search field input of the given config object from the searchParameters.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchFieldFromParameter: function(searchConfig) {
        var self = this;
        searchConfig.value = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.searchParameters[searchConfig.key][term].enabled;
        }).map(function(term) {
          return self.searchParameters[searchConfig.key][term].text;
        }).join(', ');

        this.$$('#input_' + searchConfig.key).value = searchConfig.value;
      },

      /**
       * Updates the date input of the given config object from the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateDateFieldFromParameter: function(searchConfig, updatePath) {
        var parameterKey = this.dateConfig[searchConfig.key];
        searchConfig.value = {};
        if(this.searchParameters[parameterKey][searchConfig.key]) {
          searchConfig.value[searchConfig.key] = this.searchParameters[parameterKey][searchConfig.key];
        }
        this.set(updatePath, searchConfig.value);
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog so that new queries can run.
       */
      handleSearch: function() {
        this._updateSearchParametersFromFields();

        if(DigBehaviors.FilterBehavior.areAllFacetsDisabled(this.searchParameters, ['sort'])) {
          return;
        }

        this.toggleSearchFieldsDialog();
      },

      /**
       * Clears all of the search fields in the dialog.
       */
      resetAllSearchFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        this._searchFields.forEach(function(dialogConfig, dialogIndex) {
          if(dialogConfig.data) {
            dialogConfig.data.forEach(function(searchConfig, searchIndex) {
              if(dateKeys.indexOf(searchConfig.key) >= 0) {
                self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'value'], {});
              } else {
                self.$$('#input_' + searchConfig.key).value = '';
              }
            });
          }
        });
      },

      /**
       * Cancels the changes to the search fields and closes the dialog.
       */
      cancelSearch: function() {
        this.userCanceled = true;
        this.toggleSearchFieldsDialog();
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _checkSearchFieldInputKey: function(event) {
        if(event.keyCode === 13) {
          this.handleSearch();
        }
      }
    });
  })();
  </script>
</dom-module>
